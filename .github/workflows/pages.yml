# GitHub Pages éƒ¨ç½²å·¥ä½œæµ
# è‡ªåŠ¨æ„å»ºæ–‡æ¡£å¹¶éƒ¨ç½²åˆ° GitHub Pages
name: éƒ¨ç½²æ–‡æ¡£åˆ° GitHub Pages

on:
  # åœ¨æ¨é€åˆ°é»˜è®¤åˆ†æ”¯æ—¶è¿è¡Œ
  push:
    branches: ["main"]
    # åªåœ¨æ–‡æ¡£ç›¸å…³æ–‡ä»¶å˜æ›´æ—¶è§¦å‘
    paths:
      - 'doc/**'
      - 'src/**'
      - 'pyproject.toml'
      - '.github/workflows/pages.yml'

  # å…è®¸ä» Actions é€‰é¡¹å¡æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  workflow_dispatch:

# è®¾ç½® GITHUB_TOKEN çš„æƒé™ä»¥å…è®¸éƒ¨ç½²åˆ° GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# å…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # æ„å»ºå’Œéƒ¨ç½²ä½œä¸š
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      # å¢å¼ºè¿è¡Œå™¨å®‰å…¨æ€§
      - name: å¢å¼ºè¿è¡Œå™¨å®‰å…¨æ€§
        uses: step-security/harden-runner@v2
        with:
          egress-policy: block
          allowed-endpoints: >
            pypi.org:443
            files.pythonhosted.org:443
            github.com:443
            api.github.com:443
      
      # æ£€å‡ºä»£ç åº“
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: "pyproject.toml"
      
      # å®‰è£…ç³»ç»Ÿä¾èµ–
      # graphviz: ç”¨äºç”Ÿæˆå›¾è¡¨
      # pandoc: ç”¨äºæ–‡æ¡£æ ¼å¼è½¬æ¢
      - name: å®‰è£…ä¾èµ–å¹¶é‡è¯•
        run: |
          for i in {1..3}; do
            sudo apt-get update && \
            sudo apt-get install -y --fix-missing pandoc graphviz fonts-freefont-ttf && break
            sleep 10
          done
      
      # å®‰è£…é¡¹ç›®ä¾èµ–
      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install .[doc,dev]
      
      # æ„å»º HTML æ–‡æ¡£
      - name: ğŸ”§ æ„å»º HTML æ–‡æ¡£
        run: invoke doc
      
      # éªŒè¯æ„å»ºç»“æœ
      - name: éªŒè¯æ„å»ºç»“æœ
        run: |
          if [ ! -f "doc/_build/html/index.html" ]; then
            echo "æ„å»ºå¤±è´¥ï¼šindex.html æœªç”Ÿæˆ"
            exit 1
          fi
      
      # é…ç½® Pages
      - name: é…ç½® Pages
        uses: actions/configure-pages@v4
      
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'doc/_build/html/'
      
      # éƒ¨ç½²åˆ° GitHub Pages
      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
